<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YCCC Nursing Lab Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://sdk.userbase.com/2/userbase.js"></script>
    <script src="js/config.js" type="module"></script>
    <style>
        .low-stock { border-left: 4px solid #ef4444; }
        .medium-stock { border-left: 4px solid #f59e0b; }
        .high-stock { border-left: 4px solid #10b981; }
        .search-highlight { background-color: #fef3c7; font-weight: bold; }
        .category-badge { font-size: 0.75rem; }
        .loading { opacity: 0.6; pointer-events: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    </style>
<link type="text/css" rel="stylesheet" href="css/style.css"/>
</head>
<body class="bg-base-100">
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <!-- Configuration Help Banner -->
        <div id="configHelp" class="alert alert-warning mb-4 max-w-md mx-auto" style="display: none;">
            <div>
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <h3 class="font-bold">Configuration Required</h3>
                    <div class="text-xs">Please set up your environment variables in the .env file</div>
                </div>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-xl w-full max-w-md">
            <div class="card-body">
                <div class="text-center mb-6">
                    <i class="fas fa-hospital-alt text-4xl text-primary mb-4"></i>
                    <h2 class="card-title text-2xl justify-center">YCCC Nursing Lab</h2>
                    <p class="text-base-content opacity-70">Inventory Management System</p>
                    <p class="text-sm text-base-content opacity-60 mt-2">York County Community College</p>
                </div>
                
                <div id="loginForm" class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input type="text" id="loginUsername" placeholder="Enter username" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter password" class="input input-bordered" />
                    </div>
                    <button class="btn btn-primary w-full" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                    </button>
                    <div class="divider">OR</div>
                    <button class="btn btn-outline w-full" onclick="showSignupForm()">
                        <i class="fas fa-user-plus mr-2"></i>Create New Account
                    </button>
                </div>

                <div id="signupForm" class="space-y-4 hidden">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input type="text" id="signupUsername" placeholder="Choose username" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input type="password" id="signupPassword" placeholder="Choose password" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confirm Password</span>
                        </label>
                        <input type="password" id="confirmPassword" placeholder="Confirm password" class="input input-bordered" />
                    </div>
                    <button class="btn btn-primary w-full" onclick="handleSignup()">
                        <i class="fas fa-user-plus mr-2"></i>Create Account
                    </button>
                    <button class="btn btn-outline w-full" onclick="showLoginForm()">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Sign In
                    </button>
                </div>

                <div id="authLoading" class="text-center py-4 hidden">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                    <p class="mt-2">Authenticating...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until authenticated) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="navbar bg-primary text-primary-content shadow-lg">
            <div class="flex-1">
                <i class="fas fa-hospital-alt text-2xl mr-3"></i>
                <h1 class="text-xl font-bold">YCCC Nursing Lab Inventory</h1>
            </div>
            <div class="flex-none gap-2">
                <div class="badge badge-secondary badge-lg">
                    <span id="totalItems">0</span> Items
                </div>
                <div id="connectionStatus" class="badge badge-success badge-sm">
                    <i class="fas fa-wifi mr-1"></i>Connected
                </div>
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost btn-sm">
                        <i class="fas fa-user mr-2"></i>
                        <span id="currentUser"></span>
                        <i class="fas fa-chevron-down ml-2"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a onclick="handleLogout()"><i class="fas fa-sign-out-alt mr-2"></i>Sign Out</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-base-100 p-6 rounded-lg shadow-xl text-center">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="mt-4 text-lg">Loading inventory data...</p>
            </div>
        </div>

        <!-- Rest of your existing inventory interface goes here -->
        <!-- Dashboard Stats -->
        <div class="container mx-auto p-4">
            <div class="alert alert-info mb-6">
                <i class="fas fa-info-circle"></i>
                <div>
                    <h3 class="font-bold">York County Community College Nursing Lab</h3>
                    <div class="text-sm">Shared inventory management system for all nursing program staff and students.</div>
                </div>
            </div>
            
            <!-- Search and Filter Section -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">Search Inventory</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Search Items</span>
                            </label>
                            <input type="text" id="searchInput" placeholder="Search by item name..." class="input input-bordered" oninput="filterInventory()" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Filter by Location</span>
                            </label>
                            <select id="locationFilter" class="select select-bordered" onchange="filterInventory()">
                                <option value="">All Locations</option>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Filter by Category</span>
                            </label>
                            <select id="categoryFilter" class="select select-bordered" onchange="filterInventory()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Add Item Form -->
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h2 class="card-title">Add New Inventory Item</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Item Name *</span>
                            </label>
                            <input type="text" id="itemName" placeholder="Enter item name" class="input input-bordered" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Location *</span>
                            </label>
                            <input type="text" id="itemLocation" placeholder="e.g., Storage Shelf # 1" class="input input-bordered" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Quantity *</span>
                            </label>
                            <input type="text" id="itemQuantity" placeholder="e.g., 25 or 5 boxes" class="input input-bordered" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Description</span>
                            </label>
                            <input type="text" id="itemDescription" placeholder="Size, type, etc." class="input input-bordered" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Shelf/Drawer</span>
                            </label>
                            <input type="text" id="itemShelf" placeholder="e.g., Shelf # 2" class="input input-bordered" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Tub #</span>
                            </label>
                            <input type="text" id="itemTub" placeholder="e.g., 7" class="input input-bordered" />
                        </div>
                    </div>
                    <div class="card-actions justify-end mt-4">
                        <button class="btn btn-primary" onclick="addItem()">
                            <i class="fas fa-plus mr-2"></i>Add Item
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Inventory List -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">Current Inventory</h2>
                    <div id="inventoryList" class="space-y-2">
                        <!-- Inventory items will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Get configuration from secure config manager
        const CONFIG = window.AppConfig.get();

        // Global variables
        let supabase = null;
        let currentUser = null;
        let inventoryData = [];
        let filteredData = [];
        let editingItemId = null;

        // Initialize the application
        async function init() {
            try {
                // Check if configuration is properly set up
                if (!window.AppConfig.isConfigured()) {
                    document.getElementById('configHelp').style.display = 'block';
                    showToast('Please configure your environment variables', 'warning');
                    return;
                }
                
                // Initialize Userbase
                const session = await userbase.init({ appId: CONFIG.userbase.appId });
                
                // Check if user is already signed in
                if (session.user) {
                    await handleSuccessfulAuth(session.user);
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize application', 'error');
            }
        }

        // Authentication functions
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('Please enter both username and password', 'error');
                return;
            }

            showAuthLoading(true);
            try {
                const user = await userbase.signIn({ username, password });
                await handleSuccessfulAuth(user);
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            } finally {
                showAuthLoading(false);
            }
        }

        async function handleSignup() {
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!username || !password || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            showAuthLoading(true);
            try {
                const user = await userbase.signUp({ username, password });
                await handleSuccessfulAuth(user);
                showToast('Account created successfully! Welcome to YCCC Nursing Lab.', 'success');
            } catch (error) {
                console.error('Signup error:', error);
                showToast('Signup failed: ' + error.message, 'error');
            } finally {
                showAuthLoading(false);
            }
        }

        async function handleLogout() {
            try {
                await userbase.signOut();
                currentUser = null;
                supabase = null;
                inventoryData = [];
                filteredData = [];
                showAuthScreen();
                showToast('Signed out successfully', 'info');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error signing out', 'error');
            }
        }

        async function handleSuccessfulAuth(user) {
            currentUser = user;
            document.getElementById('currentUser').textContent = user.username;
            
            // Initialize Supabase with auto-connection
            await initializeSupabase();
            
            // Show main app
            showMainApp();
            
            // Load inventory data (shared for all users)
            await loadInventoryData();
            populateFilters();
            updateStats();
            renderInventory(filteredData);
            setupEventListeners();
        }

        // Database initialization with auto-connection
        async function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);
                
                // Test connection
                const { data: testData, error: testError } = await supabase
                    .from('inventory_items')
                    .select('count')
                    .limit(1);
                
                if (testError && testError.code === 'PGRST116') {
                    showToast('Database table not found - please contact administrator', 'warning');
                } else if (testError) {
                    console.log('Database test error:', testError);
                }
                
                updateConnectionStatus('Connected', 'success');
            } catch (error) {
                console.error('Database connection error:', error);
                updateConnectionStatus('Connection Failed', 'error');
                showToast('Database connection failed: ' + error.message, 'error');
            }
        }

        // Enhanced data loading - SHARED inventory for all users
        async function loadInventoryData() {
            if (!supabase) return;
            
            showLoading(true);
            try {
                // Load ALL inventory items (shared across all users)
                const { data, error } = await supabase
                    .from('inventory_items')
                    .select('*')
                    .order('item');
                    
                if (error) {
                    console.error('Error loading data:', error);
                    if (error.code === 'PGRST116') {
                        showToast('Database table not found - please contact administrator', 'warning');
                    } else {
                        throw error;
                    }
                }
                
                inventoryData = data || [];
                filteredData = [...inventoryData];
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading inventory data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Add new item function - adds to shared inventory
        async function addItem() {
            const itemName = document.getElementById('itemName').value.trim();
            const location = document.getElementById('itemLocation').value.trim();
            const quantity = document.getElementById('itemQuantity').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const shelf = document.getElementById('itemShelf').value.trim();
            const tub = document.getElementById('itemTub').value.trim();

            if (!itemName || !location || !quantity) {
                showToast('Please fill in required fields (Name, Location, Quantity)', 'error');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('inventory_items')
                    .insert([{
                        user_id: 'yccc-shared', // Shared inventory identifier
                        item: itemName,
                        description: description,
                        location: location,
                        shelf: shelf,
                        tub: tub,
                        quantity: quantity
                    }])
                    .select();

                if (error) throw error;

                // Clear form
                document.getElementById('itemName').value = '';
                document.getElementById('itemLocation').value = '';
                document.getElementById('itemQuantity').value = '';
                document.getElementById('itemDescription').value = '';
                document.getElementById('itemShelf').value = '';
                document.getElementById('itemTub').value = '';

                // Refresh data
                await loadInventoryData();
                populateFilters();
                updateStats();
                renderInventory(filteredData);

                showToast('Item added to YCCC Nursing Lab inventory!', 'success');
            } catch (error) {
                console.error('Error adding item:', error);
                showToast('Error adding item: ' + error.message, 'error');
            }
        }

        // Filter inventory function
        function filterInventory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredData = inventoryData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.item.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));
                
                const matchesLocation = !locationFilter || item.location === locationFilter;
                
                const matchesCategory = !categoryFilter || item.item.toLowerCase().includes(categoryFilter.toLowerCase());

                return matchesSearch && matchesLocation && matchesCategory;
            });

            renderInventory(filteredData);
            updateStats();
        }

        // UI Helper functions
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        }

        function showSignupForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showAuthLoading(show) {
            const loading = document.getElementById('authLoading');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (show) {
                loading.classList.remove('hidden');
                loginForm.classList.add('hidden');
                signupForm.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                if (signupForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                } else {
                    signupForm.classList.remove('hidden');
                }
            }
        }

        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainApp = document.getElementById('mainApp');
            
            if (show) {
                loadingOverlay.classList.remove('hidden');
                mainApp.classList.add('loading');
            } else {
                loadingOverlay.classList.add('hidden');
                mainApp.classList.remove('loading');
            }
        }

        function populateFilters() {
            // Populate location filter
            const locations = [...new Set(inventoryData.map(item => item.location))].sort();
            const locationFilter = document.getElementById('locationFilter');
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            locations.forEach(location => {
                locationFilter.innerHTML += `<option value="${location}">${location}</option>`;
            });

            // Populate category filter (based on common item types)
            const categories = ['Gauze', 'Tape', 'Sponge', 'Dressing', 'Swab', 'Pad', 'Bandage'];
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
        }

        function updateStats() {
            const totalItemsElement = document.getElementById('totalItems');
            if (totalItemsElement) {
                totalItemsElement.textContent = filteredData.length;
            }
        }

        function renderInventory(data) {
            const inventoryList = document.getElementById('inventoryList');
            if (!inventoryList) return;

            if (data.length === 0) {
                inventoryList.innerHTML = `
                    <div class="text-center py-8 text-base-content/70">
                        <i class="fas fa-box-open text-4xl mb-4"></i>
                        <p>No inventory items found matching your criteria.</p>
                    </div>
                `;
                return;
            }

            inventoryList.innerHTML = data.map(item => `
                <div class="card bg-base-200 shadow-sm">
                    <div class="card-body p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="card-title text-lg">${item.item}</h3>
                                <p class="text-sm text-base-content/70 mb-2">${item.description || 'No description'}</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                                    <span><i class="fas fa-map-marker-alt mr-1 text-primary"></i><strong>Location:</strong> ${item.location}</span>
                                    ${item.shelf ? `<span><i class="fas fa-layer-group mr-1 text-secondary"></i><strong>Shelf:</strong> ${item.shelf}</span>` : ''}
                                    ${item.tub ? `<span><i class="fas fa-box mr-1 text-accent"></i><strong>Tub:</strong> ${item.tub}</span>` : ''}
                                    <span><i class="fas fa-cubes mr-1 text-info"></i><strong>Qty:</strong> ${item.quantity}</span>
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button class="btn btn-sm btn-outline" onclick="editItem('${item.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-error btn-outline" onclick="deleteItem('${item.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setupEventListeners() {
            console.log('Event listeners set up for YCCC Nursing Lab inventory');
        }

        // Make functions globally accessible for onclick handlers
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.showLoginForm = showLoginForm;
        window.showSignupForm = showSignupForm;
        window.handleLogout = handleLogout;
        window.addItem = addItem;
        window.filterInventory = filterInventory;

        function updateConnectionStatus(status, type) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `badge badge-${type} badge-sm`;
            statusEl.innerHTML = `<i class="fas fa-${type === 'success' ? 'wifi' : type === 'warning' ? 'exclamation-triangle' : 'times'} mr-1"></i>${status}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg mb-2 fade-in fixed top-4 right-4 z-50 max-w-sm`;
            toast.innerHTML = `
                <div>
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation-triangle' : 'info'}-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Start the application
        init();
    </script>
<script type="text/javascript" src="js/script.js"></script>
</body>
</html>