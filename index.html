<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YCCC Nursing Lab Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://sdk.userbase.com/2/userbase.js"></script>
    <script src="js/config.js" type="module"></script>
    <style>
        .low-stock { border-left: 4px solid #ef4444; }
        .medium-stock { border-left: 4px solid #f59e0b; }
        .high-stock { border-left: 4px solid #10b981; }
        .search-highlight { background-color: #fef3c7; font-weight: bold; }
        .category-badge { font-size: 0.75rem; }
        .loading { opacity: 0.6; pointer-events: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Auth Screen Specific Styles */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-base-100">
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container hidden">
        <!-- Configuration Help Banner -->
        <div id="configHelp" class="alert alert-warning mb-4 max-w-md mx-auto" style="display: none;">
            <div>
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <h3 class="font-bold">Configuration Required</h3>
                    <div class="text-xs">Please set up your environment variables in the .env file</div>
                </div>
            </div>
        </div>
        
        <div class="card bg-base-100 shadow-xl w-full max-w-md">
            <div class="card-body">
                <div class="text-center mb-6">
                    <i class="fas fa-hospital-alt text-4xl text-primary mb-4"></i>
                    <h2 class="card-title text-2xl justify-center">YCCC Nursing Lab</h2>
                    <p class="text-base-content opacity-70">Inventory Management System</p>
                    <p class="text-sm text-base-content opacity-60 mt-2">York County Community College</p>
                </div>
                
                <div id="loginForm" class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input type="text" id="loginUsername" placeholder="Enter username" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input type="password" id="loginPassword" placeholder="Enter password" class="input input-bordered" />
                    </div>
                    <button class="btn btn-primary w-full" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                    </button>
                    <div class="divider">OR</div>
                    <button class="btn btn-outline w-full" onclick="showSignupForm()">
                        <i class="fas fa-user-plus mr-2"></i>Create New Account
                    </button>
                </div>

                <div id="signupForm" class="space-y-4 hidden">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input type="text" id="signupUsername" placeholder="Choose username" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input type="password" id="signupPassword" placeholder="Choose password" class="input input-bordered" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confirm Password</span>
                        </label>
                        <input type="password" id="confirmPassword" placeholder="Confirm password" class="input input-bordered" />
                    </div>
                    <button class="btn btn-primary w-full" onclick="handleSignup()">
                        <i class="fas fa-user-plus mr-2"></i>Create Account
                    </button>
                    <button class="btn btn-outline w-full" onclick="showLoginForm()">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Sign In
                    </button>
                </div>

                <div id="authLoading" class="text-center py-4 hidden">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                    <p class="mt-2">Authenticating...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application (hidden until authenticated) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="navbar bg-primary text-primary-content shadow-lg">
            <div class="flex-1">
                <i class="fas fa-hospital-alt text-2xl mr-3"></i>
                <h1 class="text-xl font-bold">YCCC Nursing Lab Inventory</h1>
            </div>
            <div class="flex-none gap-2">
                <div class="badge badge-secondary badge-lg">
                    <span id="totalItems">0</span> Items
                </div>
                <div id="connectionStatus" class="badge badge-success badge-sm">
                    <i class="fas fa-wifi mr-1"></i>Connected
                </div>
                <!-- User Dropdown - Re-added -->
                <div class="dropdown dropdown-end">
                    <label tabindex="0" class="btn btn-ghost btn-sm">
                        <i class="fas fa-user mr-2"></i>
                        <span id="currentUser"></span>
                        <i class="fas fa-chevron-down ml-2"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a onclick="handleLogout()"><i class="fas fa-sign-out-alt mr-2"></i>Sign Out</a></li>
                    </ul>
                </div>
                <!-- Database Setup Button - Re-added from old HTML but modified to show Userbase config -->
                <button class="btn btn-ghost btn-sm" onclick="showDatabaseSetup()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Dashboard Stats - From old HTML -->
        <div class="container mx-auto p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat bg-base-200 rounded-lg shadow">
                    <div class="stat-figure text-primary">
                        <i class="fas fa-boxes text-2xl"></i>
                    </div>
                    <div class="stat-title">Total Items</div>
                    <div class="stat-value text-primary" id="statTotal">0</div>
                </div>
                <div class="stat bg-base-200 rounded-lg shadow">
                    <div class="stat-figure text-warning">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <div class="stat-title">Low Stock</div>
                    <div class="stat-value text-warning" id="statLowStock">0</div>
                </div>
                <div class="stat bg-base-200 rounded-lg shadow">
                    <div class="stat-figure text-info">
                        <i class="fas fa-map-marker-alt text-2xl"></i>
                    </div>
                    <div class="stat-title">Locations</div>
                    <div class="stat-value text-info" id="statLocations">0</div>
                </div>
                <div class="stat bg-base-200 rounded-lg shadow">
                    <div class="stat-figure text-success">
                        <i class="fas fa-tags text-2xl"></i>
                    </div>
                    <div class="stat-title">Categories</div>
                    <div class="stat-value text-success" id="statCategories">0</div>
                </div>
            </div>

            <!-- Action Buttons - From old HTML -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="btn btn-primary" onclick="showAddItemModal()">
                    <i class="fas fa-plus mr-2"></i>Add New Item
                </button>
                <button class="btn btn-secondary" onclick="exportData()">
                    <i class="fas fa-download mr-2"></i>Export Data
                </button>
                <button class="btn btn-accent" onclick="showImportModal()">
                    <i class="fas fa-upload mr-2"></i>Smart Import CSV
                </button>
                <button class="btn btn-info" onclick="initializeWithSampleData()" id="sampleDataBtn">
                    <i class="fas fa-database mr-2"></i>Load Sample Data
                </button>
            </div>

            <!-- Search and Filters - From old HTML -->
            <div class="card bg-base-200 shadow-lg mb-6">
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Search -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">
                                    <i class="fas fa-search mr-2"></i>Search Items
                                </span>
                            </label>
                            <input type="text" id="searchInput" placeholder="Search by item name or description..." 
                                   class="input input-bordered w-full" oninput="filterAndSearch()" />
                        </div>

                        <!-- Location Filter -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">
                                    <i class="fas fa-map-marker-alt mr-2"></i>Location
                                </span>
                            </label>
                            <select id="locationFilter" class="select select-bordered w-full" onchange="filterAndSearch()">
                                <option value="">All Locations</option>
                            </select>
                        </div>

                        <!-- Category Filter -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">
                                    <i class="fas fa-tags mr-2"></i>Category
                                </span>
                            </label>
                            <select id="categoryFilter" class="select select-bordered w-full" onchange="filterAndSearch()">
                                <option value="">All Categories</option>
                            </select>
                        </div>

                        <!-- Stock Level Filter -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">
                                    <i class="fas fa-chart-bar mr-2"></i>Stock Level
                                </span>
                            </label>
                            <select id="stockFilter" class="select select-bordered w-full" onchange="filterAndSearch()">
                                <option value="">All Stock Levels</option>
                                <option value="low">Low Stock (≤5)</option>
                                <option value="medium">Medium Stock (6-20)</option>
                                <option value="high">High Stock (>20)</option>
                                <option value="empty">No Quantity Listed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sort Options - From old HTML -->
                    <div class="flex flex-wrap gap-2 mt-4">
                        <button class="btn btn-sm btn-outline" onclick="sortItems('name')">
                            <i class="fas fa-sort-alpha-down mr-1"></i>Sort by Name
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="sortItems('quantity')">
                            <i class="fas fa-sort-numeric-down mr-1"></i>Sort by Quantity
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="sortItems('location')">
                            <i class="fas fa-sort mr-1"></i>Sort by Location
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="resetFilters()">
                            <i class="fas fa-refresh mr-1"></i>Reset Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Info - From old HTML -->
            <div class="flex justify-between items-center mb-4">
                <div class="text-sm opacity-70">
                    Showing <span id="resultCount">0</span> of <span id="totalCount">0</span> items
                </div>
                <div class="flex gap-2">
                    <div class="badge badge-error badge-sm">
                        <div class="w-2 h-2 bg-red-500 rounded-full mr-1"></div>
                        Low Stock
                    </div>
                    <div class="badge badge-warning badge-sm">
                        <div class="w-2 h-2 bg-yellow-500 rounded-full mr-1"></div>
                        Medium Stock
                    </div>
                    <div class="badge badge-success badge-sm">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-1"></div>
                        High Stock
                    </div>
                </div>
            </div>

            <!-- Loading Indicator - From old HTML -->
            <div id="loadingIndicator" class="text-center py-8 hidden">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="mt-2 text-base-content opacity-60">Loading inventory...</p>
            </div>

            <!-- Inventory Grid - From old HTML -->
            <div id="inventoryGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Items will be populated here -->
            </div>

            <!-- No Results Message - From old HTML -->
            <div id="noResults" class="text-center py-12 hidden">
                <i class="fas fa-search text-4xl text-base-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-base-content mb-2">No items found</h3>
                <p class="text-base-content opacity-60">Try adjusting your search criteria or filters</p>
            </div>
        </div>
    </div>

    <!-- Database Setup Modal - From old HTML, adapted for Userbase -->
    <div id="databaseSetupModal" class="modal">
        <div class="modal-box max-w-4xl">
            <h3 class="font-bold text-lg mb-4">Database & Authentication Configuration</h3>
            <div class="space-y-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <h4 class="font-bold">Setup Instructions:</h4>
                        <ol class="list-decimal list-inside mt-2 space-y-1 text-sm">
                            <li>Ensure your GitHub repository secrets (`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, `VITE_USERBASE_APP_ID`) are set.</li>
                            <li>If running locally, create a `.env` file with these variables (prefixed with `VITE_`).</li>
                            <li>Your Supabase table (`inventory_items`) and RLS policies have been automatically set up by the AI.</li>
                            <li>If you encounter issues, check your browser console for errors.</li>
                        </ol>
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="cursor-pointer label">
                        <span class="label-text">Enable Demo Mode (Local Storage) - No database or signup required</span>
                        <input type="checkbox" id="demoMode" class="checkbox" onchange="toggleDemoModeFields()" />
                    </label>
                </div>

                <div id="supabaseConfigFields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Supabase Project URL</span>
                        </label>
                        <input type="url" id="supabaseUrl" placeholder="https://your-project.supabase.co" 
                               class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Supabase Anon Key</span>
                        </label>
                        <input type="password" id="supabaseKey" placeholder="Your anon public key" 
                               class="input input-bordered" />
                    </div>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Userbase App ID</span>
                    </label>
                    <input type="text" id="userbaseAppId" placeholder="Your Userbase App ID" 
                           class="input input-bordered" />
                </div>

                <!-- Manual SQL Instructions - Updated -->
                <div class="collapse collapse-arrow bg-base-200">
                    <input type="checkbox" /> 
                    <div class="collapse-title text-sm font-medium">
                        <i class="fas fa-code mr-2"></i>Manual Database Setup (if auto-creation fails)
                    </div>
                    <div class="collapse-content text-xs">
                        <p class="mb-2">If you experience database errors, ensure the `inventory_items` table and RLS policies exist in your Supabase project. You can run this SQL in your Supabase SQL Editor:</p>
                        <div class="mockup-code">
                            <pre><code>-- Create the inventory_items table
CREATE TABLE IF NOT EXISTS public.inventory_items (
    id SERIAL PRIMARY KEY,
    user_id TEXT NOT NULL,
    item TEXT NOT NULL,
    description TEXT,
    location TEXT NOT NULL,
    shelf TEXT,
    tub TEXT,
    quantity TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE public.inventory_items ENABLE ROW LEVEL SECURITY;

-- Create policy for user isolation (all authenticated users see all data)
CREATE POLICY "Allow all operations for authenticated users" 
ON public.inventory_items FOR ALL 
USING (true);

-- Add indexes for better performance
CREATE INDEX IF NOT EXISTS idx_inventory_items_user_id ON public.inventory_items(user_id);
CREATE INDEX IF NOT EXISTS idx_inventory_items_created_at ON public.inventory_items(created_at);
CREATE INDEX IF NOT EXISTS idx_inventory_items_item ON public.inventory_items(item);
</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-action">
                <button class="btn btn-primary" onclick="connectDatabase()">
                    <i class="fas fa-plug mr-2"></i>Connect &amp; Load
                </button>
                <button class="btn" onclick="closeDatabaseSetup()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal - From old HTML -->
    <div id="itemModal" class="modal">
        <div class="modal-box w-11/12 max-w-2xl">
            <h3 class="font-bold text-lg mb-4" id="modalTitle">Add New Item</h3>
            <form id="itemForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Item Name *</span>
                        </label>
                        <input type="text" id="itemName" name="item" required 
                               class="input input-bordered" placeholder="e.g., ABD Pads" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Description</span>
                        </label>
                        <input type="text" id="itemDescription" name="description" 
                               class="input input-bordered" placeholder="e.g., 8&quot; X 10&quot;" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Location *</span>
                        </label>
                        <select id="itemLocation" name="location" required class="select select-bordered">
                            <option value="">Select Location</option>
                            <option value="Storage Shelf # 1">Storage Shelf # 1</option>
                            <option value="Storage Shelf # 2">Storage Shelf # 2</option>
                            <option value="Wound Care Cart">Wound Care Cart</option>
                            <option value="Sink Counter">Sink Counter</option>
                            <option value="Assessment Cart">Assessment Cart</option>
                            <option value="Nurses Station">Nurses Station</option>
                            <option value="Under Nurses Station Counter">Under Nurses Station Counter</option>
                        </select>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Shelf/Drawer</span>
                        </label>
                        <input type="text" id="itemShelf" name="shelf" 
                               class="input input-bordered" placeholder="e.g., Right Drawer # 6" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Tub Number</span>
                        </label>
                        <input type="text" id="itemTub" name="tub" 
                               class="input input-bordered" placeholder="e.g., 7" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Quantity</span>
                        </label>
                        <input type="text" id="itemQuantity" name="quantity" 
                               class="input input-bordered" placeholder="e.g., 24 or 2 boxes" />
                    </div>
                </div>
                
                <div class="modal-action">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>Save Item
                    </button>
                    <button type="button" class="btn" onclick="closeItemModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Smart Import Modal - From old HTML -->
    <div id="importModal" class="modal">
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">Smart CSV Import</h3>
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Select CSV File</span>
                    </label>
                    <input type="file" id="importFile" accept=".csv" class="file-input file-input-bordered" 
                           onchange="previewCSV()" />
                </div>
                
                <div class="alert alert-success">
                    <i class="fas fa-magic"></i>
                    <div>
                        <h4 class="font-bold">Smart Import Features:</h4>
                        <ul class="text-sm mt-1 space-y-1">
                            <li>• Automatically handles uppercase/lowercase columns</li>
                            <li>• Maps common column variations (e.g., "SHELF #/DRAWER #" → "shelf")</li>
                            <li>• Shows preview before importing</li>
                            <li>• Skips empty rows automatically</li>
                        </ul>
                    </div>
                </div>

                <!-- CSV Preview -->
                <div id="csvPreview" class="hidden">
                    <h4 class="font-semibold mb-2">CSV Preview & Column Mapping:</h4>
                    <div class="overflow-x-auto">
                        <table class="table table-compact w-full">
                            <thead>
                                <tr>
                                    <th>CSV Column</th>
                                    <th>Maps To</th>
                                    <th>Sample Data</th>
                                </tr>
                            </thead>
                            <tbody id="csvPreviewBody">
                                <!-- Preview rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2">
                        <span class="text-sm opacity-70">Found <span id="previewRowCount">0</span> rows to import</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-action">
                <button class="btn btn-primary" onclick="importData()" id="importBtn" disabled>
                    <i class="fas fa-upload mr-2"></i>Import Data
                </button>
                <button class="btn" onclick="closeImportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal - From old HTML -->
    <div id="deleteModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-error mb-4">Confirm Deletion</h3>
            <p class="mb-4">Are you sure you want to delete this item? This action cannot be undone.</p>
            <div class="bg-base-200 p-3 rounded mb-4">
                <p class="font-semibold" id="deleteItemName"></p>
                <p class="text-sm opacity-70" id="deleteItemDetails"></p>
            </div>
            
            <div class="modal-action">
                <button class="btn btn-error" onclick="confirmDelete()">
                    <i class="fas fa-trash mr-2"></i>Delete
                </button>
                <button class="btn" onclick="closeDeleteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications - From old HTML -->
    <div id="toastContainer" class="toast toast-top toast-end z-50">
        <!-- Toasts will be added here dynamically -->
    </div>

    <script type="module">
        // Get configuration from secure config manager
        const CONFIG = window.AppConfig.get();

        // Global variables
        let supabase = null;
        let currentUser = null; // Still needed for Userbase auth context
        let inventoryData = [];
        let filteredData = [];
        let currentSort = null;
        let editingItemId = null;
        let deleteItemId = null;
        let demoMode = false;
        let csvData = null;

        // Column mapping for flexible CSV import
        const columnMappings = {
            // Item name variations
            'item': 'item',
            'item name': 'item',
            'name': 'item',
            'product': 'item',
            
            // Description variations
            'description': 'description',
            'desc': 'description',
            'details': 'description',
            'notes': 'description',
            
            // Location variations
            'location': 'location',
            'loc': 'location',
            'storage': 'location',
            'area': 'location',
            
            // Shelf variations
            'shelf': 'shelf',
            'shelf #/drawer #': 'shelf',
            'shelf/drawer': 'shelf',
            'drawer': 'shelf',
            'position': 'shelf',
            
            // Tub variations
            'tub': 'tub',
            'tub #': 'tub',
            'tub number': 'tub',
            'container': 'tub',
            'bin': 'tub',
            
            // Quantity variations
            'quantity': 'quantity',
            'qty': 'quantity',
            'amount': 'quantity',
            'count': 'quantity',
            'stock': 'quantity'
        };

        // Initialize the application - Adapted for Userbase and shared inventory
        async function init() {
            try {
                // Check if configuration is properly set up
                if (!window.AppConfig.isConfigured()) {
                    document.getElementById('configHelp').style.display = 'block';
                    showToast('Please configure your environment variables', 'warning');
                    showDatabaseSetup(); // Show setup modal
                    return;
                }
                
                // Initialize Userbase
                const session = await userbase.init({ appId: CONFIG.userbase.appId });
                
                // Check if user is already signed in
                if (session.user) {
                    await handleSuccessfulAuth(session.user);
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize application: ' + error.message, 'error');
                showAuthScreen(); // Ensure auth screen is visible on init error
            }
        }

        // Authentication functions - Retained from current version
        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showToast('Please enter both username and password', 'error');
                return;
            }

            showAuthLoading(true);
            try {
                const user = await userbase.signIn({ username, password });
                await handleSuccessfulAuth(user);
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            } finally {
                showAuthLoading(false);
            }
        }

        async function handleSignup() {
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!username || !password || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            showAuthLoading(true);
            try {
                const user = await userbase.signUp({ username, password });
                await handleSuccessfulAuth(user);
                showToast('Account created successfully! Welcome to YCCC Nursing Lab.', 'success');
            } catch (error) {
                console.error('Signup error:', error);
                showToast('Signup failed: ' + error.message, 'error');
            } finally {
                showAuthLoading(false);
            }
        }

        async function handleLogout() {
            try {
                await userbase.signOut();
                currentUser = null;
                supabase = null;
                inventoryData = [];
                filteredData = [];
                showAuthScreen();
                showToast('Signed out successfully', 'info');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error signing out', 'error');
            }
        }

        async function handleSuccessfulAuth(user) {
            currentUser = user;
            document.getElementById('currentUser').textContent = user.username;
            
            // Initialize Supabase with auto-connection
            await initializeSupabase();
            
            // Show main app
            showMainApp();
            
            // Load inventory data (shared for all users)
            await loadInventoryData();
            populateFilters();
            updateStats();
            renderInventory(filteredData);
            setupEventListeners();
        }

        // Database initialization with auto-connection - Adapted to use config.js
        async function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);
                
                // Test connection
                const { data: testData, error: testError } = await supabase
                    .from('inventory_items')
                    .select('count')
                    .limit(1);
                
                if (testError && testError.code === 'PGRST116') {
                    showToast('Database table not found - please contact administrator or use setup modal', 'warning');
                    // Optionally show setup modal if table not found
                    showDatabaseSetup();
                } else if (testError) {
                    console.log('Database test error:', testError);
                    showToast('Database connection issue: ' + testError.message, 'error');
                    // Optionally show setup modal if there's a connection issue
                    showDatabaseSetup();
                }
                
                updateConnectionStatus('Connected', 'success');
            } catch (error) {
                console.error('Database connection error:', error);
                updateConnectionStatus('Connection Failed', 'error');
                showToast('Database connection failed: ' + error.message, 'error');
            }
        }

        // Connect Database function for modal - Adapted to use config.js and Userbase
        async function connectDatabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const userbaseAppId = document.getElementById('userbaseAppId').value.trim();
            const demo = document.getElementById('demoMode').checked;
            
            if (demo) {
                demoMode = true;
                localStorage.setItem('demoMode', 'true');
                // Clear any stored Supabase/Userbase credentials if switching to demo
                localStorage.removeItem('supabaseUrl');
                localStorage.removeItem('supabaseKey');
                localStorage.removeItem('userbaseAppId');
                updateConnectionStatus('Demo Mode', 'warning');
                await loadFromLocalStorage();
                populateFilters();
                updateStats();
                renderInventory(filteredData);
                closeDatabaseSetup();
                showToast('Demo mode activated - data stored locally', 'info');
                return;
            }
            
            if (!url || !key || !userbaseAppId) {
                showToast('Please enter Supabase URL, API Key, and Userbase App ID', 'error');
                return;
            }
            
            // Update local storage for persistence (if not using env vars)
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            localStorage.setItem('userbaseAppId', userbaseAppId);
            localStorage.setItem('demoMode', 'false');

            // Re-initialize app with new config
            // This is a simplified re-init, a full app reload might be better for production
            window.AppConfig = new Config(); // Re-create config object
            await init(); // Re-run init to pick up new config and re-authenticate if needed
            
            closeDatabaseSetup();
        }

        // Load inventory data - SHARED inventory for all users
        async function loadInventoryData() {
            if (demoMode) {
                await loadFromLocalStorage();
                return;
            }
            
            if (!supabase) {
                showToast('Database not connected. Please configure in settings.', 'error');
                showDatabaseSetup();
                return;
            }

            showLoading(true);
            try {
                // Load ALL inventory items (shared across all users)
                const { data, error } = await supabase
                    .from('inventory_items')
                    .select('*')
                    .order('item');
                    
                if (error) {
                    console.error('Error loading data:', error);
                    if (error.code === 'PGRST116') {
                        showToast('Database table not found - please contact administrator or use setup modal', 'warning');
                        showDatabaseSetup();
                    } else {
                        throw error;
                    }
                }
                
                inventoryData = data || [];
                filteredData = [...inventoryData];
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading inventory data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Add new item function - adds to shared inventory with 'yccc-shared' user_id
        async function addItem() { // This function is called from the main page form
            const itemName = document.getElementById('itemName').value.trim();
            const location = document.getElementById('itemLocation').value.trim();
            const quantity = document.getElementById('itemQuantity').value.trim();
            const description = document.getElementById('itemDescription').value.trim();
            const shelf = document.getElementById('itemShelf').value.trim();
            const tub = document.getElementById('itemTub').value.trim();

            if (!itemName || !location || !quantity) {
                showToast('Please fill in required fields (Name, Location, Quantity)', 'error');
                return;
            }

            try {
                // Use a fixed user_id for shared inventory
                const itemToSave = {
                    user_id: 'yccc-shared', 
                    item: itemName,
                    description: description,
                    location: location,
                    shelf: shelf,
                    tub: tub,
                    quantity: quantity
                };

                await saveItem(itemToSave); // Call the generic saveItem function

                // Clear form
                document.getElementById('itemName').value = '';
                document.getElementById('itemLocation').value = '';
                document.getElementById('itemQuantity').value = '';
                document.getElementById('itemDescription').value = '';
                document.getElementById('itemShelf').value = '';
                document.getElementById('itemTub').value = '';

                // Refresh data
                await loadInventoryData();
                populateFilters();
                updateStats();
                renderInventory(filteredData);

                showToast('Item added to YCCC Nursing Lab inventory!', 'success');
            } catch (error) {
                console.error('Error adding item:', error);
                showToast('Error adding item: ' + error.message, 'error');
            }
        }

        // Filter inventory function - from old HTML
        function filterAndSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            filteredData = inventoryData.filter(item => {
                const matchesSearch = !searchTerm || 
                    item.item.toLowerCase().includes(searchTerm) ||
                    (item.description && item.description.toLowerCase().includes(searchTerm));

                const matchesLocation = !locationFilter || item.location === locationFilter;
                const matchesCategory = !categoryFilter || categorizeItem(item) === categoryFilter;
                const stockLevel = getStockLevel(item.quantity);
                const matchesStock = !stockFilter || stockLevel === stockFilter;

                return matchesSearch && matchesLocation && matchesCategory && matchesStock;
            });

            if (currentSort) {
                sortItems(currentSort, false);
            } else {
                renderInventory(filteredData);
            }
            updateStats(); // Update stats after filtering
        }

        // Sort items function - from old HTML
        function sortItems(sortBy, render = true) {
            currentSort = sortBy;
            
            filteredData.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.item.localeCompare(b.item);
                    case 'quantity':
                        const qtyA = parseInt(a.quantity?.toString().replace(/[^\d]/g, '') || '0');
                        const qtyB = parseInt(b.quantity?.toString().replace(/[^\d]/g, '') || '0');
                        return qtyB - qtyA; // Descending for quantity
                    case 'location':
                        return a.location.localeCompare(b.location);
                    default:
                        return 0;
                }
            });

            if (render) {
                renderInventory(filteredData);
            }
        }

        // Reset filters function - from old HTML
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('locationFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('stockFilter').value = '';
            currentSort = null;
            filteredData = [...inventoryData];
            renderInventory(filteredData);
            updateStats(); // Update stats after reset
        }

        // Save item to database - Adapted for shared inventory
        async function saveItem(itemData) {
            if (demoMode) {
                return saveToLocalStorage(itemData);
            }
            
            if (!supabase) {
                showToast('Database not connected. Please configure in settings.', 'error');
                showDatabaseSetup();
                throw new Error('Database not connected');
            }

            try {
                // Ensure user_id is set to the shared ID
                itemData.user_id = 'yccc-shared'; 

                if (editingItemId) {
                    const { data, error } = await supabase
                        .from('inventory_items')
                        .update({ ...itemData, updated_at: new Date().toISOString() })
                        .eq('id', editingItemId)
                        .select(); // Select the updated row
                        
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('inventory_items')
                        .insert([itemData])
                        .select(); // Select the inserted row
                        
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving item:', error);
                throw error;
            }
        }

        // Delete item from database - From old HTML
        async function deleteItem(id) {
            if (demoMode) {
                await deleteFromLocalStorage(id);
                return;
            }
            
            if (!supabase) {
                showToast('Database not connected. Please configure in settings.', 'error');
                showDatabaseSetup();
                throw new Error('Database not connected');
            }

            try {
                const { error } = await supabase
                    .from('inventory_items')
                    .delete()
                    .eq('id', id);
                    
                if (error) throw error;
                
            } catch (error) {
                console.error('Error deleting item:', error);
                throw error;
            }
        }

        // Local storage functions for demo mode - From old HTML
        async function loadFromLocalStorage() {
            const stored = localStorage.getItem('inventoryData');
            if (stored) {
                inventoryData = JSON.parse(stored);
            } else {
                inventoryData = getSampleData();
                localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            }
            filteredData = [...inventoryData];
        }

        async function saveToLocalStorage(itemData) {
            if (editingItemId) {
                const index = inventoryData.findIndex(item => item.id === editingItemId);
                if (index !== -1) {
                    inventoryData[index] = { ...inventoryData[index], ...itemData, updated_at: new Date().toISOString() };
                }
            } else {
                const newItem = {
                    id: Date.now(),
                    ...itemData,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                inventoryData.push(newItem);
            }
            
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            filteredData = [...inventoryData];
            return inventoryData[inventoryData.length - 1];
        }

        async function deleteFromLocalStorage(id) {
            inventoryData = inventoryData.filter(item => item.id !== id);
            localStorage.setItem('inventoryData', JSON.stringify(inventoryData));
            filteredData = [...inventoryData];
        }

        // UI Functions - Adapted from old HTML and current version
        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        }

        function showSignupForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showAuthLoading(show) {
            const loading = document.getElementById('authLoading');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (show) {
                loading.classList.remove('hidden');
                loginForm.classList.add('hidden');
                signupForm.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                if (signupForm.classList.contains('hidden')) {
                    loginForm.classList.remove('hidden');
                }
            }
        }

        function showDatabaseSetup() {
            // Populate modal fields with current CONFIG values if available
            if (CONFIG.supabase.url && !CONFIG.supabase.url.includes('your_')) {
                document.getElementById('supabaseUrl').value = CONFIG.supabase.url;
            }
            if (CONFIG.supabase.key && !CONFIG.supabase.key.includes('your_')) {
                document.getElementById('supabaseKey').value = CONFIG.supabase.key;
            }
            if (CONFIG.userbase.appId && !CONFIG.userbase.appId.includes('your_')) {
                document.getElementById('userbaseAppId').value = CONFIG.userbase.appId;
            }
            
            document.getElementById('demoMode').checked = demoMode;
            toggleDemoModeFields(); // Adjust visibility based on demo mode
            document.getElementById('databaseSetupModal').classList.add('modal-open');
        }

        function closeDatabaseSetup() {
            document.getElementById('databaseSetupModal').classList.remove('modal-open');
        }
        
        function toggleDemoModeFields() {
            const supabaseFields = document.getElementById('supabaseConfigFields');
            const userbaseField = document.getElementById('userbaseAppId');
            const demoCheckbox = document.getElementById('demoMode');

            if (demoCheckbox.checked) {
                supabaseFields.classList.add('hidden');
                userbaseField.closest('.form-control').classList.add('hidden');
            } else {
                supabaseFields.classList.remove('hidden');
                userbaseField.closest('.form-control').classList.remove('hidden');
            }
        }

        function updateConnectionStatus(status, type) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `badge badge-${type} badge-sm`;
            statusEl.innerHTML = `<i class="fas fa-${type === 'success' ? 'wifi' : type === 'warning' ? 'exclamation-triangle' : 'times'} mr-1"></i>${status}`;
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('inventoryGrid');
            
            if (show) {
                loading.classList.remove('hidden');
                grid.classList.add('loading'); // Apply a class to dim/disable grid
            } else {
                loading.classList.add('hidden');
                grid.classList.remove('loading');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg mb-2 fade-in`;
            toast.innerHTML = `
                <div>
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation-triangle' : 'info'}-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Item management functions - From old HTML
        function showAddItemModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Add New Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemModal').classList.add('modal-open');
        }

        function showEditItemModal(id) {
            const item = inventoryData.find(i => i.id === id);
            if (!item) return;
            
            editingItemId = id;
            document.getElementById('modalTitle').textContent = 'Edit Item';
            
            document.getElementById('itemName').value = item.item || '';
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('itemLocation').value = item.location || '';
            document.getElementById('itemShelf').value = item.shelf || '';
            document.getElementById('itemTub').value = item.tub || '';
            document.getElementById('itemQuantity').value = item.quantity || '';
            
            document.getElementById('itemModal').classList.add('modal-open');
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('modal-open');
            editingItemId = null;
        }

        async function handleItemSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const itemData = {
                item: formData.get('item'),
                description: formData.get('description'),
                location: formData.get('location'),
                shelf: formData.get('shelf'),
                tub: formData.get('tub'),
                quantity: formData.get('quantity')
            };
            
            try {
                await saveItem(itemData);
                await loadInventoryData();
                populateFilters();
                updateStats();
                renderInventory(filteredData);
                closeItemModal();
                
                showToast(editingItemId ? 'Item updated successfully!' : 'Item added successfully!', 'success');
            } catch (error) {
                showToast('Error saving item: ' + error.message, 'error');
            }
        }

        function showDeleteModal(id) {
            const item = inventoryData.find(i => i.id === id);
            if (!item) return;
            
            deleteItemId = id;
            document.getElementById('deleteItemName').textContent = item.item;
            document.getElementById('deleteItemDetails').textContent = 
                `${item.description || 'No description'} - ${item.location}`;
            
            document.getElementById('deleteModal').classList.add('modal-open');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('modal-open');
            deleteItemId = null;
        }

        async function confirmDelete() {
            if (!deleteItemId) return;
            
            try {
                await deleteItem(deleteItemId);
                await loadInventoryData();
                populateFilters();
                updateStats();
                renderInventory(filteredData);
                closeDeleteModal();
                
                showToast('Item deleted successfully!', 'success');
            } catch (error) {
                showToast('Error deleting item: ' + error.message, 'error');
            }
        }

        function showImportModal() {
            document.getElementById('importModal').classList.add('modal-open');
            // Reset the modal
            document.getElementById('csvPreview').classList.add('hidden');
            document.getElementById('importBtn').disabled = true;
            document.getElementById('importFile').value = '';
            csvData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('modal-open');
        }

        // CSV parsing and import functions - From old HTML
        function previewCSV() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showToast('CSV file must have at least a header row and one data row', 'error');
                    return;
                }
                
                const headers = parseCSVLine(lines[0]);
                const sampleRow = parseCSVLine(lines[1]);
                
                // Map headers to our schema
                const mappedHeaders = headers.map(header => {
                    const normalized = header.toLowerCase().trim();
                    return columnMappings[normalized] || 'unmapped';
                });
                
                // Show preview
                const previewBody = document.getElementById('csvPreviewBody');
                previewBody.innerHTML = '';
                
                headers.forEach((header, index) => {
                    const mappedTo = mappedHeaders[index];
                    const sampleData = sampleRow[index] || '';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="font-mono text-sm">${header}</td>
                        <td>
                            <span class="badge ${mappedTo === 'unmapped' ? 'badge-warning' : 'badge-success'} badge-sm">
                                ${mappedTo === 'unmapped' ? 'Will be ignored' : mappedTo}
                            </span>
                        </td>
                        <td class="text-sm opacity-70">${sampleData}</td>
                    `;
                    previewBody.appendChild(row);
                });
                
                // Store parsed data
                csvData = {
                    headers: headers,
                    mappedHeaders: mappedHeaders,
                    lines: lines.slice(1) // Skip header
                };
                
                document.getElementById('previewRowCount').textContent = csvData.lines.length;
                document.getElementById('csvPreview').classList.remove('hidden');
                document.getElementById('importBtn').disabled = false;
            };
            
            reader.readAsText(file);
        }

        // Parse CSV line handling quotes and commas - From old HTML
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result.map(field => field.replace(/^"|"$/g, '')); // Remove surrounding quotes
        }

        // Smart import function - Adapted for shared inventory
        async function importData() {
            if (!csvData) {
                showToast('Please select and preview a CSV file first', 'error');
                return;
            }
            
            try {
                showLoading(true);
                let importedCount = 0;
                let skippedCount = 0;
                
                for (const line of csvData.lines) {
                    if (!line.trim()) {
                        skippedCount++;
                        continue;
                    }
                    
                    const values = parseCSVLine(line);
                    const item = {};
                    
                    // Map values to our schema
                    csvData.mappedHeaders.forEach((mappedHeader, index) => {
                        if (mappedHeader !== 'unmapped' && values[index]) {
                            item[mappedHeader] = values[index].trim();
                        }
                    });
                    
                    // Ensure required fields
                    if (!item.item || !item.location) {
                        skippedCount++;
                        continue;
                    }
                    
                    // Set user_id for shared inventory
                    item.user_id = 'yccc-shared'; 

                    await saveItem(item); // Use the generic saveItem function
                    importedCount++;
                }
                
                await loadInventoryData();
                populateFilters();
                updateStats();
                renderInventory(filteredData);
                closeImportModal();
                
                showToast(`Successfully imported ${importedCount} items! ${skippedCount > 0 ? `Skipped ${skippedCount} invalid rows.` : ''}`, 'success');
                
            } catch (error) {
                showToast('Error importing data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Export data function - From old HTML
        function exportData() {
            const csv = convertToCSV(inventoryData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_export_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Data exported successfully!', 'success');
        }

        // Convert to CSV function - From old HTML
        function convertToCSV(data) {
            const headers = ['item', 'description', 'location', 'shelf', 'tub', 'quantity'];
            const csvContent = [
                headers.join(','),
                ...data.map(item => 
                    headers.map(header => 
                        `"${(item[header] || '').toString().replace(/"/g, '&quot;')}"`
                    ).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        // Load sample data function - Adapted for shared inventory
        async function initializeWithSampleData() {
            if (inventoryData.length > 0) {
                if (!confirm('This will add sample data to your existing inventory. Continue?')) {
                    return;
                }
            }
            
            const sampleData = getSampleData();
            
            try {
                for (const item of sampleData) {
                    item.user_id = 'yccc-shared'; // Ensure sample data also uses shared ID
                    await saveItem(item);
                }
                
                await loadInventoryData();
                populateFilters();
                updateStats();
                renderInventory(filteredData);
                
                showToast(`Added ${sampleData.length} sample items!`, 'success');
                // document.getElementById('sampleDataBtn').style.display = 'none'; // Keep button visible for multiple loads
                
            } catch (error) {
                showToast('Error loading sample data: ' + error.message, 'error');
            }
        }

        // Sample data - From old HTML
        function getSampleData() {
            return [
                {"item": "ABD Pads", "description": "", "location": "Storage Shelf # 1", "shelf": "Shelf # 2", "tub": "7", "quantity": "2"},
                {"item": "ABD Pads", "description": "", "location": "Storage Shelf # 1", "shelf": "Shelf # 4", "tub": "13", "quantity": "24"},
                {"item": "ABD Pads", "description": "8&quot; X 10&quot;", "location": "Wound Care Cart", "shelf": "Right Drawer # 6", "tub": "", "quantity": "5"},
                {"item": "Adhesive Bandage", "description": "Wound Closure", "location": "Wound Care Cart", "shelf": "Right Drawer # 1", "tub": "", "quantity": "19"},
                {"item": "Gauze Pads", "description": "3 X 3", "location": "Storage Shelf # 1", "shelf": "Shelf # 4", "tub": "13", "quantity": "175"},
                {"item": "Sterile Saline", "description": "100 ml for wounds", "location": "Storage Shelf # 1", "shelf": "Top of shelving", "tub": "", "quantity": "12"},
                {"item": "Tape Surgical Paper", "description": "1&quot;", "location": "Storage Shelf # 1", "shelf": "Shelf # 4", "tub": "13", "quantity": "33 rolls"}
            ];
        }

        // Category mapping - From old HTML
        function categorizeItem(item) {
            const itemName = item.item.toLowerCase();
            const description = item.description?.toLowerCase() || '';
            
            if (itemName.includes('gauze') || itemName.includes('pad') || itemName.includes('sponge')) {
                return 'Gauze & Pads';
            } else if (itemName.includes('tape') || itemName.includes('adhesive')) {
                return 'Tape & Adhesives';
            } else if (itemName.includes('dressing') || itemName.includes('bandage') || itemName.includes('tefla')) {
                return 'Dressings & Bandages';
            } else if (itemName.includes('surgical') || itemName.includes('sterile') || itemName.includes('staple') || itemName.includes('suture')) {
                return 'Surgical Supplies';
            } else if (itemName.includes('drain') || itemName.includes('tube') || itemName.includes('catheter')) {
                return 'Drains & Tubes';
            } else if (itemName.includes('measuring') || itemName.includes('scissors') || itemName.includes('tray')) {
                return 'Tools & Equipment';
            } else if (itemName.includes('cotton') || itemName.includes('swab') || itemName.includes('alcohol') || itemName.includes('prep')) {
                return 'Cleaning & Prep';
            } else if (itemName.includes('glove') || itemName.includes('protection')) {
                return 'Protection';
            } else {
                return 'Other Supplies';
            }
        }

        // Get stock level - From old HTML
        function getStockLevel(quantity) {
            if (!quantity || quantity === '') return 'empty';
            
            const numericValue = parseInt(quantity.toString().replace(/[^\d]/g, ''));
            
            if (isNaN(numericValue) || numericValue === 0) return 'empty';
            if (numericValue <= 5) return 'low';
            if (numericValue <= 20) return 'medium';
            return 'high';
        }

        // Get stock class for styling - From old HTML
        function getStockClass(level) {
            switch(level) {
                case 'low': return 'low-stock';
                case 'medium': return 'medium-stock';
                case 'high': return 'high-stock';
                default: return '';
            }
        }

        // Get stock badge for display - From old HTML
        function getStockBadge(level) {
            switch(level) {
                case 'low': return '<span class="badge badge-error badge-sm">Low Stock</span>';
                case 'medium': return '<span class="badge badge-warning badge-sm">Medium</span>';
                case 'high': return '<span class="badge badge-success badge-sm">In Stock</span>';
                default: return '<span class="badge badge-ghost badge-sm">No Qty</span>';
            }
        }

        // Highlight search terms - From old HTML
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Render inventory to grid - From old HTML
        function renderInventory(data) {
            const grid = document.getElementById('inventoryGrid');
            const noResults = document.getElementById('noResults');
            const searchTerm = document.getElementById('searchInput').value;

            if (data.length === 0) {
                grid.innerHTML = '';
                noResults.classList.remove('hidden');
                document.getElementById('resultCount').textContent = 0; // Update result count
                return;
            }

            noResults.classList.add('hidden');
            
            grid.innerHTML = data.map(item => {
                const category = categorizeItem(item);
                const stockLevel = getStockLevel(item.quantity);
                const stockClass = getStockClass(stockLevel);
                const stockBadge = getStockBadge(stockLevel);
                
                const fullLocation = `${item.location}${item.shelf ? ' - ' + item.shelf : ''}${item.tub ? ' (Tub ' + item.tub + ')' : ''}`;
                
                return `
                    <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow ${stockClass} fade-in">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="card-title text-sm font-bold">
                                    ${highlightText(item.item, searchTerm)}
                                </h3>
                                ${stockBadge}
                            </div>
                            
                            ${item.description ? `
                                <p class="text-xs text-base-content opacity-70 mb-2">
                                    ${highlightText(item.description, searchTerm)}
                                </p>
                            ` : ''}
                            
                            <div class="space-y-1 text-xs">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt text-primary mr-2"></i>
                                    <span class="truncate">${fullLocation}</span>
                                </div>
                                
                                <div class="flex items-center">
                                    <i class="fas fa-boxes text-secondary mr-2"></i>
                                    <span class="font-semibold">
                                        ${item.quantity || 'Not specified'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card-actions justify-between items-center mt-3">
                                <div class="badge badge-outline category-badge">
                                    ${category}
                                </div>
                                <div class="flex gap-1">
                                    <button class="btn btn-xs btn-primary" onclick="showEditItemModal(${item.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-xs btn-error" onclick="showDeleteModal(${item.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('resultCount').textContent = data.length;
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterAndSearch);
            document.getElementById('locationFilter').addEventListener('change', filterAndSearch);
            document.getElementById('categoryFilter').addEventListener('change', filterAndSearch);
            document.getElementById('stockFilter').addEventListener('change', filterAndSearch);
            document.getElementById('itemForm').addEventListener('submit', handleItemSubmit);
        }

        // Make functions globally accessible for onclick handlers
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.showLoginForm = showLoginForm;
        window.showSignupForm = showSignupForm;
        window.handleLogout = handleLogout;
        window.showDatabaseSetup = showDatabaseSetup;
        window.closeDatabaseSetup = closeDatabaseSetup;
        window.connectDatabase = connectDatabase;
        window.showAddItemModal = showAddItemModal;
        window.showEditItemModal = showEditItemModal;
        window.closeItemModal = closeItemModal;
        window.handleItemSubmit = handleItemSubmit;
        window.showDeleteModal = showDeleteModal;
        window.closeDeleteModal = closeDeleteModal;
        window.confirmDelete = confirmDelete;
        window.showImportModal = showImportModal;
        window.closeImportModal = closeImportModal;
        window.previewCSV = previewCSV;
        window.importData = importData;
        window.exportData = exportData;
        window.initializeWithSampleData = initializeWithSampleData;
        window.filterAndSearch = filterAndSearch;
        window.sortItems = sortItems;
        window.resetFilters = resetFilters;

        // Start the application
        init();
    </script>
</body>
</html>